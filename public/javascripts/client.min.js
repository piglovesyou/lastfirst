var AbstractComponent,BlankWord,BrowserType,CSS_PREFIX,ImageSearcher,Message,Time,Word,WordList,currentDocs_,message,socket,socketInit,time,userId_,words,__slice=Array.prototype.slice,__bind=function(a,b){return function(){return a.apply(b,arguments)}},__hasProp=Object.prototype.hasOwnProperty,__extends=function(a,b){function d(){this.constructor=a}for(var c in b)__hasProp.call(b,c)&&(a[c]=b[c]);return d.prototype=b.prototype,a.prototype=new d,a.__super__=b.prototype,a};(function(){var a,b,c;return this._===void 0?c=require("underscore"):c=this._,a=function(a){var b,d,e;return b=1,d=a.length,d>=2&&/^[ゃゅょ|ー]$/.test(a[1])&&(d>=3&&/^[ー]$/.test(a[2])?b=3:b=2),e=[],c(b).times(function(b){return e.push(a.slice(0,b+1))}),e},b=function(a){var b,d,e;b=1,e=a.length,d=e-1,e>=2&&/^[ゃゅょ|ー]$/.test(a[d])&&(e>=3&&/^[ゃゅょ]$/.test(a[d-1])?b=3:b=2),a=c.last(a,b);if(c.isArray(a))return a=a.join("")},c.mixin({isValidWord:function(a){return c.isString(a)&&/^[あ-ん|ー]+$/.test(a)&&/^[^を]+$/.test(a)&&!/っ$/.test(a)?c.all(a.split(""),function(a,b,c){return b===0?/^[^ゃゅょ|^っ|^ー]$/.test(a):/^[ゃゅょ]$/.test(a)?/^[きしちにひみりぎじぢび]$/.test(c[b-1]):a==="っ"?/^[^っ]$/.test(c[b-1]):!0}):!1},isEndsN:function(a){return/ん$/.test(a)},isValidLastFirst:function(d,e){return c.include(a(e),b(d))}})})(),_.mixin({addSingletonGetter:function(a){return a.getInstance=function(){return a.instance_||(a.instance_=new a)}},parseParamString:function(a,b){var c,d,e,f,g,h;b==null&&(b="&"),e={},h=a.split(b);for(f=0,g=h.length;f<g;f++)d=h[f],c=d.split("="),e[c[0]]=c[1];return e},stringifyParam:function(a,b){var c,d,e,f,g,h;b==null&&(b="&"),f="",d=_.keys(a),e=d.length-1;for(g=0,h=d.length;g<h;g++)c=d[g],f+=c+"="+a[c],g!==e&&(f+=b);return f},now:function(){return Date.now()||+(new Date)},getCookies:function(){return _.parseParamString(document.cookie,"; ")},setCookies:function(a){var b,c;c=[];for(b in a)c.push(document.cookie=b+"="+a[b]);return c},clearCookies:function(){return _.setCookies({token:"",expires:(new Date(_.now()-36e5)).toString()})},trimHTML:function(a){return a.replace(/(<\/.+?>)[\s\S]*?(<)/g,"$1$2")},escapeHTML:function(a){return a.indexOf("<")&&a.replace(/</g,""),a.indexOf(">")&&a.replace(/>/g,""),a.indexOf("&")&&a.replace(/&/g,""),a.indexOf('"')&&a.replace(/"/g,""),a},padString:function(a,b,c){var d,e;return c==null&&(c="0"),_.isString(a)||(a=a.toString()),d=b-a.length,e="",d>=1&&(_(d).times(function(){return e+=c}),a=e+a),a}}),BrowserType={WEBKIT:0,GECKO:1,MSIE:2,OPERA:3,OTHER:4},_.mixin({getBrowserVendor:function(){var a;return a=navigator.userAgent.toLowerCase(),a.indexOf("webkit")<0?a.indexOf("gecko")<0?a.indexOf("msie")<0?a.indexOf("opera")<0?BrowserType.OTHER:BrowserType.OPERA:BrowserType.MSIE:BrowserType.GECKO:BrowserType.WEBKIT}}),CSS_PREFIX=null,_.mixin({getCssPrefix:function(){if(!_.isNull(CSS_PREFIX))return CSS_PREFIX;switch(_.getBrowserVendor()){case BrowserType.WEBKIT:return CSS_PREFIX="-webkit-";case BrowserType.GECKO:return CSS_PREFIX="-moz-";case BrowserType.MSIE:return CSS_PREFIX="-ms-";case BrowserType.OPERA:return CSS_PREFIX="-o-";case BrowserType.OTHER:return CSS_PREFIX=""}},niceDate:function(a,b){var c,d,e,f,g,h,i,j,k,l,m;return g=1e3,e=60*g,d=60*e,c=24*d,h=7*c,f=31*c,i=365*c,l={en:{AGO:" ago",AFTER:" after",SECOND:" second",MINUTE:" minute",HOUR:" hour",DAY:" day",WEEK:" week",MONTH:" month",YEAR:" year",PLURAL:"s"},ja:{AGO:"前",AFTER:"後",SECOND:"秒",MINUTE:"分",HOUR:"時間",DAY:"日",WEEK:"週",MONTH:"月",YEAR:"年"}},j={en:{HOUR_MINUTE:"%_:%_",MONTH_DATE:"%_.%_",YEAR_MONTH_DATE:"%_.%_.%_"},ja:{HOUR_MINUTE:"%_:%_",MONTH_DATE:["%_",l.ja.MONTH,"%_",l.ja.DAY].join(""),YEAR_MONTH_DATE:["%_",l.ja.YEAR,"%_",l.ja.MONTH,"%_",l.ja.DAY].join("")}},m=function(a,b,c){return a=Math.floor(a),c.PLURAL&&a>1?a+b+c.PLURAL:a+b},k=function(){var a,b,c,d,e;a=arguments[0],c=2>arguments.length?[]:__slice.call(arguments,1);for(d=0,e=c.length;d<e;d++)b=c[d],a=a.replace("%_",b);return a},function(a,f){var h,n,o,p;if(_.isString(a)||_.isNumber(a))a=new Date(a);if(_.isDate(a))return p=(new Date).getTime(),f=_.isString(f)&&l[f]?f:"ja",b=l[f],o=j[f],n=p-a.getTime(),h=n>0?b.AGO:b.AFTER,n=Math.abs(n),n<e?""+m(n/g,b.SECOND,b)+h:n<d?""+m(n/e,b.MINUTE,b)+h:n<c?""+m(n/d,b.HOUR,b)+h:n<c*3?""+m(n/c,b.DAY,b)+h:n<i?""+k(o.MONTH_DATE,a.getMonth()+1,a.getDate()):""+k(o.YEAR_MONTH_DATE,a.getFullYear(),a.getMonth()+1,a.getDate())}}()}),ImageSearcher=function(){function a(){this.hasScriptLoaded_()&&this.createImageSearchInstance_()}return a.prototype.execute=function(a){if(this.canExecute_())return this.googleImageSearch_.execute(a)},a.prototype.setCallback=function(a){!this.googleImageSearch_&&this.hasScriptLoaded_()&&this.createImageSearchInstance_();if(this.googleImageSearch_&&!this.hasCallback_)return this.hasCallback_=!0,this.googleImageSearch_.setSearchCompleteCallback(this.googleImageSearch_,a,[this.googleImageSearch_])},a.prototype.googleImageSearch_=null,a.prototype.hasCallback_=null,a.prototype.onSearchCompleteCallback_=null,a.prototype.hasScriptLoaded_=function(){return window.google&&window.google.search&&window.google.search.ImageSearch},a.prototype.canExecute_=function(){return!!this.hasScriptLoaded_()&&!!this.hasCallback_&&(this.googleImageSearch_||this.createImageSearchInstance_()),this.googleImageSearch_&&this.hasCallback_},a.prototype.createImageSearchInstance_=function(){return this.googleImageSearch_=new google.search.ImageSearch,this.googleImageSearch_.setRestriction(google.search.Search.RESTRICT_SAFESEARCH,google.search.Search.SAFESEARCH_OFF),this.googleImageSearch_.setRestriction(google.search.ImageSearch.RESTRICT_RIGHTS,google.search.ImageSearch.RIGHTS_REUSE)},a}(),_.addSingletonGetter(ImageSearcher),ImageSearcher.getInstance(),AbstractComponent=function(){function a(){}return a.prototype.element=null,a.prototype.isInDocument=!1,a.prototype.getElement=function(){return this.element},a.prototype.isInDocument=!1,a.prototype.canRender=function(){return!0},a.prototype.render=function(){return this.isInDocument=!0},a.prototype.decorate=function(a){this.element=$(a);if(this.element)return this.isInDocument=!0},a.prototype.dispose=function(){var a,b;if(this.isInDocument){this.element.unbind(),this.element.remove(),b=[];for(a in this)_.isObject(this[a])?b.push(this[a]=null):b.push(void 0);return b}},a}(),Word=function(){function b(b,c){this.isLastPost=c,this.sendLike=__bind(this.sendLike,this),this.notAsLastWord=__bind(this.notAsLastWord,this),a=_.getUserId(),this.id=b._id,this.content=b.content,this.createdBy=b.createdBy,this.createdAt=b.createdAt,this.liked=b.liked,this.words_=null,this.wasAttachedAsLastWord=!1,this.imageSearcher_=new ImageSearcher,this.canRender()&&(this.element=$('<div class="word"></div>'))}var a;return __extends(b,AbstractComponent),a=null,b.prototype.canRender=function(){return!!(!this.isInDocument&&this.id&&this.content&&this.createdBy&&this.createdAt&&this.liked)},b.prototype.render=function(){var c,d,e,f;if(!this.canRender())return;return b.__super__.render.call(this),this.element.empty(),d="",c=$('<div class="image loading"></div>'),this.imageSearcher_.setCallback(function(a){var b,d,e=this;return a&&a.results&&!_.isEmpty(a.results&&a.results[0]&&a.results[0].url)?(d=a.results[0],b=$('<a class="image-inner" href="'+d.originalContextUrl+'" title="'+d.titleNoFormatting+'"\nstyle="background-image:url('+d.url+')" target="_blank">'+d.title+"</a>"),$("<img/>").load(function(){return c.removeClass("loading").append(b)}).error(function(){return c.text("no image").removeClass("loading")}).attr({src:a.results[0].url})):c.text("no image").removeClass("loading")}),this.imageSearcher_.execute(this.content),this.labelElm=$("<div class='label'></div>"),e=this.content,_.isEndsN(this.content)&&(e+="*"),f=$("<span class='titleElm' title='"+this.createdAt+"'>"+e+"</span>"),this.labelElm.append(f),this.renderLike_(),this.elementInner=$("<div class='inner'></div>").append(c).append(this.labelElm),this.element.append(this.elementInner),this.isLastPost?WordList.getInstance().setAsLastWord(this):this.element.removeClass("last-post"),a===this.createdBy?this.element.addClass("your-post"):this.element.removeClass("your-post")},b.prototype.notAsLastWord=function(){this.element.removeClass("last-post");if(this.wasAttachedAsLastWord)return this.elementInner.unbind("mouseenter"),this.elementInner.unbind("mouseleave"),this.wasAttachedAsLastWord=!1},b.prototype.attachTime=function(a){return this.time=a,this.time.attachElement(this.element,this.createdAt)},b.prototype.sendLike=function(a){var b;b=_.getSocket();if(b)return b.emit("like",{wordId:this.id,userId:_.getUserId()})},b.prototype.renderLike=function(a){return this.liked=a,this.likedElm&&this.likedElm.remove(),this.likeButtonElm&&this.likeButtonElm.unbind().remove(),this.renderLike_()},b.prototype.renderLike_=function(){var b,c,d,e,f;if(!_.isEmpty(this.liked)){c="",f=this.liked;for(d=0,e=f.length;d<e;d++)b=f[d],c+="6";this.likedElm=$("<span class='liked i'>"+c+"</span>"),this.labelElm.append(this.likedElm)}if(a&&a!==this.createdBy&&!_.include(this.liked,a))return this.likeButtonElm=$("<span class='like i' title='like it'>6</span>").bind("click",this.sendLike),this.labelElm.append(this.likeButtonElm)},b}(),_.addSingletonGetter(Word),BlankWord=function(){function a(){this.onMouseleaveBlankElm_=__bind(this.onMouseleaveBlankElm_,this),this.onMouseEnterBlankElm_=__bind(this.onMouseEnterBlankElm_,this),this.onSearchComplete_=__bind(this.onSearchComplete_,this),this.sendSearchRequest=__bind(this.sendSearchRequest,this),this.onKeyup_=__bind(this.onKeyup_,this),a.__super__.constructor.call(this),this.imageSearcher_=new ImageSearcher,this.onKeyup_=_.debounce(this.onKeyup_,800)}return __extends(a,AbstractComponent),a.prototype.render=function(){if(this.isInDocument)return;return a.__super__.render.call(this),this.textElm_=$('<input name="content" type="text" maxlength="7">'),this.formElm_=$(_.trimHTML('<form id="post" action="javascript:void(0)" method="POST">\n  <input style="display:none" type="submit" />\n</form>')).prepend(this.textElm_),this.imageElm_=$('<div class="image"></div>'),this.innerElm_=$(_.trimHTML('<div class="inner">\n  <div class="label">\n    <div id="post-form"></div>\n    <div class="please-login yeah">(Please login.)</div> \n  </div>\n  <div class="blank-word-google-branding">\n    <span>powered by </span>\n    <img src="https://www.google.com/uds/css/small-logo.png"/>\n  </div>\n</div>')),this.innerElm_.prepend(this.imageElm_).find("#post-form").append(this.formElm_),this.element=$('<div class="word word-blank" style="display:none"></div>').append(this.innerElm_)},a.prototype.attachEvents=function(){return this.textElm_.bind("keyup text",this.onKeyup_).val("").focus(),this.innerElm_.bind("mouseenter",this.onMouseEnterBlankElm_).bind("mouseleave",this.onMouseleaveBlankElm_),ImageSearcher.getInstance().setCallback(this.onSearchComplete_),this.imageElm_.removeAttr("style").empty()},a.prototype.detatchEvents=function(){return this.textElm_.unbind(),this.innerElm_.unbind()},a.prototype.imageSearcher_=null,a.prototype.innerElm_=null,a.prototype.formElm_=null,a.prototype.textElm_=null,a.prototype.hideTimer_=null,a.prototype.onKeyup_=function(){var a;a=this.textElm_.val();if(_.isValidWord(a))return this.sendSearchRequest(a)},a.prototype.sendSearchRequest=function(a){return this.imageElm_.removeAttr("style").addClass("loading"),a=_.escapeHTML(a),ImageSearcher.getInstance().execute(a)},a.prototype.onSearchComplete_=function(a){var b=this;return a&&a.results&&!_.isEmpty(a.results&&a.results[0]&&a.results[0].url)?$("<img/>").load(function(){var c;return c=$('<span class="image-inner" style="background-image:url('+a.results[0].url+')"></span>'),b.imageElm_.removeClass("loading").empty().append(c)}).error(function(){return b.imageElm_.text("no image").removeClass("loading")}).attr({src:a.results[0].url}):this.imageElm_.text("no image").removeClass("loading")},a.prototype.onMouseEnterBlankElm_=function(){return window.clearTimeout(this.hideTimer_)},a.prototype.onMouseleaveBlankElm_=function(){var a=this;return window.clearTimeout(this.hideTimer_),this.hideTimer_=_.delay(function(){return a.detatchEvents(),a.element.hide().remove()},3e3)},a}(),_.addSingletonGetter(BlankWord),WordList=function(){function a(){this.onClickLastWord_=__bind(this.onClickLastWord_,this),this.blankWord=BlankWord.getInstance(),this.blankWord.render()}return __extends(a,AbstractComponent),a.prototype.blankWord=null,a.prototype.empty=function(){var a,b,c,d;d=this.wordInstances_;for(b=0,c=d.length;b<c;b++)a=d[b],a.dispose();return this.wordInstances_=[],this.element.empty()},a.prototype.renderWords=function(){var a,b,c,d,e;this.element.empty(),d=this.wordInstances_,e=[];for(b=0,c=d.length;b<c;b++)a=d[b],e.push(a.render());return e},a.prototype.push=function(a){return this.wordInstances_.push(a),this.element.append(a.getElement())},a.prototype.shift=function(a){return this.wordInstances_.shift(a)},a.prototype.pop=function(){var a;return a=this.wordInstances_.pop(),a.dispose()},a.prototype.get=function(a){return _.find(this.wordInstances_,function(b){return b.id===a})},a.prototype.getLastWord=function(){return this.wordInstances_[0]},a.prototype.setAsLastWord=function(a){return this.lastWord_=a,this.lastWord_.element.addClass("last-post"),this.lastWord_.elementInner.bind("click",this.onClickLastWord_)},a.prototype.wordInstances_=[],a.prototype.lastWord_=null,a.prototype.onClickLastWord_=function(){return this.blankWord.element.prependTo(this.element).fadeIn(),this.blankWord.attachEvents(),Time.getInstance().hide(),!1},a}(),_.addSingletonGetter(WordList),Message=function(){function a(){a.__super__.constructor.apply(this,arguments)}return __extends(a,AbstractComponent),a.prototype.decorate=function(b){return a.__super__.decorate.call(this,b)},a.prototype.show=function(a){var b;return b=this.createMsg_("msg-general",a),_.delay(function(){return b.fadeOut()},7e3)},a.prototype.showImportant=function(a){var b;return b=this.createMsg_("msg-important",a),_.delay(function(){return b.fadeOut()},25e3)},a.prototype.createMsg_=function(a,b){return $("<span class='"+a+"' style='display:none'></span>").text(b).prependTo(this.element).fadeIn()},a}(),_.addSingletonGetter(Message),Time=function(){function a(){this.hide=__bind(this.hide,this),this.hideAfterDelay=__bind(this.hideAfterDelay,this),a.__super__.constructor.apply(this,arguments)}return __extends(a,AbstractComponent),a.prototype.render=function(){return a.__super__.render.call(this),this.element=$(_.trimHTML('<div class="time" style="display:none">\n  <div class="time-arrow"></div>\n  <div class="time-bg"> \n    <div class="time-round clearfix">\n      <div class="time-label">\n        <div class="time-label-twelve">12</div>\n        <div class="time-label-three">3</div>\n        <div class="time-label-six">6</div>\n        <div class="time-label-nine">9</div>\n      </div>\n      <div class="time-tick">\n        <div class="time-tick-short"></div>\n        <div class="time-tick-long"></div>\n      </div>\n      <div class="time-tick-center"></div>\n    </div>\n    <div class="time-title">\n      <div class="time-title-content"></div>\n    </div>\n  </div>\n</div>')),$("body").append(this.element),this.element.css({"margin-top":this.element.height()/-2}),this.shortTickElm_=$(".time-tick-short",this.element),this.longTickElm_=$(".time-tick-long",this.element),this.titleElm_=$(".time-title-content",this.element)},a.prototype.attachElement=function(a,b){var c,d,e,f,g=this;return a=$(a),c=new Date(b),d=this.getHourDeg_(c),e=this.getMinuteDeg_(c),f={},$(a).bind("mouseover",function(){return g.showTimer_=_.delay(function(){var b;return g.clearTimers_(),b=$(".label span:last-child",a),f=b.offset(),f.top+=b.height()/2,f.left+=b.width(),window.clearTimeout(g.hideTimer_),g.setRotate_(g.shortTickElm_,d),g.setRotate_(g.longTickElm_,e),g.titleElm_.html(g.createTitleHTML_(c)),g.element.css({top:f.top,left:f.left}).fadeIn()},400)}).bind("mouseout",this.hideAfterDelay)},a.prototype.hideAfterDelay=function(){return this.clearTimers_(),this.hideTimer_=_.delay(this.hide,3e3)},a.prototype.hide=function(){return this.element.fadeOut()},a.prototype.shortTickElm_=null,a.prototype.longTickElm_=null,a.prototype.titleElm_=null,a.prototype.hideTimer_=null,a.prototype.showTimer_=null,a.prototype.createTitleHTML_=function(a){var b,c;return b=_.padString(a.getHours(),2)+":"+_.padString(a.getMinutes(),2),c=_.niceDate(a),'<span class="time-title-digits">'+b+'</span><br />\n<span class="time-title-nice">'+c+"</span>"},a.prototype.clearTimers_=function(){return window.clearTimeout(this.showTimer_),window.clearTimeout(this.hideTimer_)},a.prototype.setRotate_=function(a,b){return a.css(_.getCssPrefix()+"transform","rotate("+b+"deg)")},a.prototype.getHourDeg_=function(a){return Math.floor(30*a.getHours())},a.prototype.getMinuteDeg_=function(a){return Math.floor(6*a.getMinutes())},a}(),_.addSingletonGetter(Time),currentDocs_=[],userId_="",socket=null,message=null,_.mixin({setToken:function(a,b){return _.setCookies({token:a,expires:b})},getToken:function(){var a;return a=_.getCookies(),a.token},setUserId:function(a){return userId_=a},getUserId:function(){return userId_},parseToken:function(a){var b,c,d;a=a.replace(/^#/,""),c=_.parseParamString(a),d=c.access_token||"",b=c.expires_in;if(d&&b)return b=(new Date(_.now()+b*1e3)).toString(),_.setToken(d,b),socket.emit("got token",{token:d})},getSocket:function(){return socket}}),_.mixin({showLoginLink:function(){return $("#login-link").show()},hideLoginLink:function(){return $("#login-link").hide()}}),socketInit=function(){return socket=io.connect(location.protocol+"//"+location.host),socket.on("update",function(a){var b,c,d,e,f;words.empty(),f=[];for(d=0,e=a.length;d<e;d++)b=a[d],c=new Word(b,d===0),c.render(),c.attachTime(time),f.push(words.push(c));return f}),socket.on("need login",function(){return message.show("Expired. Need another login."),_.showLoginLink()}),socket.on("validated nicely!",function(a){var b;return b=a.userId,_.setUserId(b),message.show("Click the last word to post. ↓"),_.hideLoginLink(),$("#logout-link").show(),$("body").addClass("logged-in").removeClass("not-logged-in"),socket.emit("pull update")}),socket.on("error message",function(a){return message.show(a.message)}),socket.on("posted successfully",function(a){return message.show('"'+a.content+'" posted!')}),socket.on("got penalty",function(a){return message.show(a.message)}),socket.on("release penalty",function(a){return message.show(a.message)}),socket.on("update like",function(a){var b;b=words.get(a._id);if(b){b.renderLike(a.liked),b.render();if(b.createdBy===_.getUserId())return message.showImportant('Somebody liked your post, "'+b.content+'"')}})},message===null,words=null,time=null,$(function(){var a;return message=Message.getInstance(),message.decorate(".message"),words=WordList.getInstance(),words.decorate(".word-list"),time=Time.getInstance(),time.render(),socketInit(),a=_.getToken(),a?socket.emit("got token",{token:a}):window.noAuthForDev||_.showLoginLink(),words.element.on("submit","#post",function(a){var b,c,d;return c=_.getUserId(),b=$('input[name="content"]',this).val(),!_.isEmpty(c)&&!_.isEmpty(b)&&(_.isValidWord(b)?(d=words.getLastWord(),c===d.createdBy?message.show("It's not your turn."):_.isValidLastFirst(d.content,b)?socket.emit("post word",{content:b,createdBy:c}):message.show("I'm not sure it's being Last and First.")):message.show("Please enter a word in HIRAGANA.")),!1})})