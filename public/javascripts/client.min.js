var $indicator_,$msgBox_,AbstractComponent,BrowserType,CSS_PREFIX,Message,Time,Word,WordList,currentDocs_,delayTimerId_,message,postLocked_,socket,socketInit,time,userId_,words,__slice=Array.prototype.slice,__bind=function(a,b){return function(){return a.apply(b,arguments)}},__hasProp=Object.prototype.hasOwnProperty,__extends=function(a,b){function d(){this.constructor=a}for(var c in b)__hasProp.call(b,c)&&(a[c]=b[c]);return d.prototype=b.prototype,a.prototype=new d,a.__super__=b.prototype,a};(function(){var a,b,c;return this._===void 0?c=require("underscore"):c=this._,a=function(a){var b,d,e;return b=1,d=a.length,d>=2&&/^[ゃゅょ|ー]$/.test(a[1])&&(d>=3&&/^[ー]$/.test(a[2])?b=3:b=2),e=[],c(b).times(function(b){return e.push(a.slice(0,b+1))}),e},b=function(a){var b,d,e;b=1,e=a.length,d=e-1,e>=2&&/^[ゃゅょ|ー]$/.test(a[d])&&(e>=3&&/^[ゃゅょ]$/.test(a[d-1])?b=3:b=2),a=c.last(a,b);if(c.isArray(a))return a=a.join("")},c.mixin({isValidWord:function(a){return c.isString(a)&&/^[あ-ん|ー]+$/.test(a)&&/^[^を]+$/.test(a)&&!/っ$/.test(a)?c.all(a.split(""),function(a,b,c){return b===0?/^[^ゃゅょ|^っ|^ー]$/.test(a):/^[ゃゅょ]$/.test(a)?/^[きしちにひみりぎじぢび]$/.test(c[b-1]):a==="っ"?/^[^っ]$/.test(c[b-1]):!0}):!1},isEndsN:function(a){return/ん$/.test(a)},isValidLastFirst:function(d,e){return c.include(a(e),b(d))}})})(),_.mixin({addSingletonGetter:function(a){return a.getInstance=function(){return a.instance_||(a.instance_=new a)}},parseParamString:function(a,b){var c,d,e,f,g,h;b==null&&(b="&"),e={},h=a.split(b);for(f=0,g=h.length;f<g;f++)d=h[f],c=d.split("="),e[c[0]]=c[1];return e},stringifyParam:function(a,b){var c,d,e,f,g,h;b==null&&(b="&"),f="",d=_.keys(a),e=d.length-1;for(g=0,h=d.length;g<h;g++)c=d[g],f+=c+"="+a[c],g!==e&&(f+=b);return f},now:function(){return Date.now()||+(new Date)},getCookies:function(){return _.parseParamString(document.cookie,"; ")},setCookies:function(a){var b,c;c=[];for(b in a)c.push(document.cookie=b+"="+a[b]);return c},padString:function(a,b,c){var d,e;return c==null&&(c="0"),_.isString(a)||(a=a.toString()),d=b-a.length,e="",d>=1&&(_(d).times(function(){return e+=c}),a=e+a),a}}),BrowserType={WEBKIT:0,GECKO:1,MSIE:2,OPERA:3,OTHER:4},_.mixin({getBrowserVendor:function(){var a;return a=navigator.userAgent.toLowerCase(),a.indexOf("webkit")<0?a.indexOf("gecko")<0?a.indexOf("msie")<0?a.indexOf("opera")<0?BrowserType.OTHER:BrowserType.OPERA:BrowserType.MSIE:BrowserType.GECKO:BrowserType.WEBKIT}}),CSS_PREFIX=null,_.mixin({getCssPrefix:function(){if(!_.isNull(CSS_PREFIX))return CSS_PREFIX;switch(_.getBrowserVendor()){case BrowserType.WEBKIT:return CSS_PREFIX="-webkit-";case BrowserType.GECKO:return CSS_PREFIX="-moz-";case BrowserType.MSIE:return CSS_PREFIX="-ms-";case BrowserType.OPERA:return CSS_PREFIX="-o-";case BrowserType.OTHER:return CSS_PREFIX=""}},niceDate:function(a,b){var c,d,e,f,g,h,i,j,k,l,m;return g=1e3,e=60*g,d=60*e,c=24*d,h=7*c,f=31*c,i=365*c,l={en:{AGO:" ago",AFTER:" after",SECOND:" second",MINUTE:" minute",HOUR:" hour",DAY:" day",WEEK:" week",MONTH:" month",YEAR:" year",PLURAL:"s"},ja:{AGO:"前",AFTER:"後",SECOND:"秒",MINUTE:"分",HOUR:"時間",DAY:"日",WEEK:"週",MONTH:"月",YEAR:"年"}},j={en:{HOUR_MINUTE:"%_:%_",MONTH_DATE:"%_.%_",YEAR_MONTH_DATE:"%_.%_.%_"},ja:{HOUR_MINUTE:"%_:%_",MONTH_DATE:["%_",l.ja.MONTH,"%_",l.ja.DAY].join(""),YEAR_MONTH_DATE:["%_",l.ja.YEAR,"%_",l.ja.MONTH,"%_",l.ja.DAY].join("")}},m=function(a,b,c){return a=Math.floor(a),c.PLURAL&&a>1?a+b+c.PLURAL:a+b},k=function(){var a,b,c,d,e;a=arguments[0],c=2>arguments.length?[]:__slice.call(arguments,1);for(d=0,e=c.length;d<e;d++)b=c[d],a=a.replace("%_",b);return a},function(a,f){var h,n,o,p;if(_.isString(a)||_.isNumber(a))a=new Date(a);if(_.isDate(a))return p=(new Date).getTime(),f=_.isString(f)&&l[f]?f:"ja",b=l[f],o=j[f],n=p-a.getTime(),h=n>0?b.AGO:b.AFTER,n=Math.abs(n),n<e?""+m(n/g,b.SECOND,b)+h:n<d?""+m(n/e,b.MINUTE,b)+h:n<c?""+m(n/d,b.HOUR,b)+h:n<c*3?""+m(n/c,b.DAY,b)+h:n<i?""+k(o.MONTH_DATE,a.getMonth()+1,a.getDate()):""+k(o.YEAR_MONTH_DATE,a.getFullYear(),a.getMonth()+1,a.getDate())}}()}),AbstractComponent=function(){function a(){}return a.prototype.element=null,a.prototype.getElement=function(){return this.element},a.prototype.isInDocument=!1,a.prototype.canRender=function(){return!0},a.prototype.render=function(){return this.isInDocument=!0},a.prototype.decorate=function(a){return this.isInDocument=!0,this.element=$(a)},a.prototype.dispose=function(){var a,b;if(this.isInDocument){this.element.unbind(),this.element.remove(),b=[];for(a in this)_.isObject(this[a])?b.push(this[a]=null):b.push(void 0);return b}},a}(),WordList=function(){function a(){this.onMouseleaveBlankElm=__bind(this.onMouseleaveBlankElm,this),this.onMouseEnterBlankElm=__bind(this.onMouseEnterBlankElm,this),this.onEnterLastWord=__bind(this.onEnterLastWord,this),this.blankElmInner=$('<div class="inner"><div class="image"></div><div class="label"></div></div>'),this.blankElm=$('<div class="word word-blank" style="display:none"></div>').append(this.blankElmInner)}return __extends(a,AbstractComponent),a.prototype.onEnterLastWordTimer=null,a.prototype.onLeaveBlankTimer=null,a.prototype.wordInstances_=[],a.prototype.lastWord_=null,a.prototype.empty=function(){var a,b,c,d;d=this.wordInstances_;for(b=0,c=d.length;b<c;b++)a=d[b],a.dispose();return this.wordInstances_=[],this.element.empty()},a.prototype.renderWords=function(){var a,b,c,d,e;this.element.empty(),d=this.wordInstances_,e=[];for(b=0,c=d.length;b<c;b++)a=d[b],e.push(a.render());return e},a.prototype.push=function(a){return this.wordInstances_.push(a),this.element.append(a.getElement())},a.prototype.shift=function(a){return this.wordInstances_.shift(a)},a.prototype.pop=function(){var a;return a=this.wordInstances_.pop(),a.dispose()},a.prototype.get=function(a){return _.find(this.wordInstances_,function(b){return b.id===a})},a.prototype.getLastWord=function(){return this.wordInstances_[0]},a.prototype.setAsLastWord=function(a){return this.lastWord_=a,this.lastWord_.element.addClass("last-post"),this.lastWord_.elementInner.bind("click",this.onEnterLastWord)},a.prototype.onEnterLastWord=function(){var a=this;return window.clearTimeout(this.onEnterLastWordTimer),this.onEnterLastWordTimer=_.delay(function(){return a.element.prepend(a.blankElm),a.blankElm.fadeIn(),a.blankElmInner.bind("mouseenter",a.onMouseEnterBlankElm).bind("mouseleave",a.onMouseleaveBlankElm)},400)},a.prototype.onMouseEnterBlankElm=function(){return window.clearTimeout(this.onLeaveBlankTimer)},a.prototype.onMouseleaveBlankElm=function(){var a=this;return console.log("leave"),window.clearTimeout(this.onLeaveBlankTimer),this.onLeaveBlankTimer=_.delay(function(){return a.blankElmInner.unbind("mouseleave"),a.blankElm.hide().remove()},1800)},a}(),_.addSingletonGetter(WordList),Word=function(){function a(a,b){this.isLastPost=b,this.sendLike=__bind(this.sendLike,this),this.notAsLastWord=__bind(this.notAsLastWord,this),this.id=a._id,this.content=a.content,this.createdBy=a.createdBy,this.createdAt=a.createdAt,this.liked=a.liked,this.words_=null,this.wasAttachedAsLastWord=!1,this.canRender()&&(this.element=$('<div class="word"></div>'))}return __extends(a,AbstractComponent),a.prototype.canRender=function(){return!!(this.id&&this.content&&this.createdBy&&this.createdAt&&this.liked)},a.prototype.render=function(){var b,c,d,e,f,g,h,i,j,k,l,m,n;if(this.canRender()){a.__super__.render.call(this),this.element.empty(),h="",k=_.getUserId(),c=$("<div class='image'>\n<img src=\"/images/dev2.png\" />\n</div>"),d=$("<div class='label'></div>"),i=this.content,_.isEndsN(this.content)&&(i+="*"),j=$("<span class='titleElm' title='"+this.createdAt+"'>"+i+"</span>"),d.append(j);if(!_.isEmpty(this.liked)){f="",n=this.liked;for(l=0,m=n.length;l<m;l++)b=n[l],f+="6";g=$("<span class='liked i'>"+f+"</span>"),d.append(g)}return k&&k!==this.createdBy&&!_.include(this.liked,k)&&(e=$("<span class='like i' title='like it'>6</span>").bind("click",this.sendLike),d.append(e)),this.elementInner=$("<div class='inner'></div>").append(c).append(d),this.element.append(this.elementInner),this.isLastPost?WordList.getInstance().setAsLastWord(this):this.element.removeClass("last-post"),k===this.createdBy?this.element.addClass("your-post"):this.element.removeClass("your-post")}},a.prototype.notAsLastWord=function(){this.element.removeClass("last-post");if(this.wasAttachedAsLastWord)return this.elementInner.unbind("mouseenter"),this.elementInner.unbind("mouseleave"),this.wasAttachedAsLastWord=!1},a.prototype.attachTime=function(a){return this.time=a,this.time.attachElement(this.element,this.createdAt)},a.prototype.sendLike=function(a){var b;b=_.getSocket();if(b)return b.emit("like",{wordId:this.id,userId:_.getUserId()})},a}(),_.addSingletonGetter(Word),Message=function(){function a(){a.__super__.constructor.apply(this,arguments)}return __extends(a,AbstractComponent),a.prototype.messageElm_=null,a.prototype.importantMessageElm_=null,a.prototype.render=function(){var b,c,d;return a.__super__.render.call(this),b=null,c=null,this.element=$('<div id="msg-box" title="close this message"></div>'),d=function(a){var c;return c=a.data.$that,$(window.document).unbind("mousemove",d),b=_.delay(function(){return c.trigger("hide")},7e3)},this.importantMessageElm_=$('<div class="msg important"></div>').hide().bind("hide",function(a){return window.clearTimeout(b),$(window.document).unbind("mousemove",d),$(this).fadeOut()}).bind("show",function(a,c){var e;return window.clearTimeout(b),e=$(this).text(c),e.fadeIn(),$(window.document).bind("mousemove",{$that:e},d)}).bind("click",function(a){return $(this).trigger("hide")}),this.messageElm_=$('<div class="msg"></div>').hide().bind("hide",function(a){return window.clearTimeout(c),$(this).fadeOut()}).bind("show",function(a,b){var d;return window.clearTimeout(c),d=$(this).text(b),d.fadeIn(),c=_.delay(function(){return d.trigger("hide")},7e3)}).bind("click",function(a){return $(this).trigger("hide")}),this.element.append(this.importantMessageElm_).append(this.messageElm_).appendTo("body")},a.prototype.show=function(a){return this.messageElm_.trigger("show",a)},a.prototype.showImportant=function(a){return this.importantMessageElm_.trigger("show",a)},a.prototype.dispose=function(){return this.importantMessageElm_.unbind(),this.messageElm_.unbind(),a.__super__.dispose.call(this)},a}(),_.addSingletonGetter(Message),Time=function(){function a(){a.__super__.constructor.apply(this,arguments)}return __extends(a,AbstractComponent),a.prototype.shortTickElm=null,a.prototype.longTickElm=null,a.prototype.titleElm=null,a.prototype.height=0,a.prototype.hideTimer=null,a.prototype.render=function(){return a.__super__.render.call(this),this.element=$('<div class="time" style="display:none"><div class="time-arrow"></div><div class="time-bg"><div class="time-round clearfix"><div class="time-label"><div class="time-label-twelve">12</div><div class="time-label-three">3</div><div class="time-label-six">6</div><div class="time-label-nine">9</div></div><div class="time-tick"><div class="time-tick-short"></div><div class="time-tick-long"></div></div><div class="time-tick-center"></div></div><div class="time-title"><div class="time-title-content"></div></div></div></div>'),$("body").append(this.element),this.element.css({"margin-top":this.element.height()/-2}),this.shortTickElm=$(".time-tick-short",this.element),this.longTickElm=$(".time-tick-long",this.element),this.titleElm=$(".time-title-content",this.element)},a.prototype.attachElement=function(a,b){var c,d,e,f,g,h=this;return a=$(a),c=new Date(b),d=this.getHourDeg_(c),e=this.getMinuteDeg_(c),g={width:$(a).width(),height:$(a).height()},f={},$(a).bind("mouseover",function(){return f=a.offset(),f.left+=g.width/2,window.clearTimeout(h.hideTimer),h.setRotate_(h.shortTickElm,d),h.setRotate_(h.longTickElm,e),h.titleElm.html(h.createTitleHTML(c)),h.element.css({top:f.top,left:f.left}).fadeIn()}).bind("mouseout",function(){return h.hideTimer=_.delay(function(){return h.element.fadeOut()},3e3)})},a.prototype.createTitleHTML=function(a){var b,c;return b=_.padString(a.getHours(),2)+":"+_.padString(a.getMinutes(),2),c=_.niceDate(a),'<span class="time-title-digits">'+b+'</span><br />\n<span class="time-title-nice">'+c+"</span>"},a.prototype.setRotate_=function(a,b){return a.css(_.getCssPrefix()+"transform","rotate("+b+"deg)")},a.prototype.getHourDeg_=function(a){return Math.floor(30*a.getHours())},a.prototype.getMinuteDeg_=function(a){return Math.floor(6*a.getMinutes())},a}(),_.addSingletonGetter(Time),Time=function(){function a(){a.__super__.constructor.apply(this,arguments)}return __extends(a,AbstractComponent),a.prototype.shortTickElm=null,a.prototype.longTickElm=null,a.prototype.titleElm=null,a.prototype.height=0,a.prototype.hideTimer=null,a.prototype.hoverTimer=null,a.prototype.render=function(){return a.__super__.render.call(this),this.element=$('<div class="time" style="display:none"><div class="time-arrow"></div><div class="time-bg"><div class="time-round clearfix"><div class="time-label"><div class="time-label-twelve">12</div><div class="time-label-three">3</div><div class="time-label-six">6</div><div class="time-label-nine">9</div></div><div class="time-tick"><div class="time-tick-short"></div><div class="time-tick-long"></div></div><div class="time-tick-center"></div></div><div class="time-title"><div class="time-title-content"></div></div></div></div>'),$("body").append(this.element),this.element.css({"margin-top":this.element.height()/-2}),this.shortTickElm=$(".time-tick-short",this.element),this.longTickElm=$(".time-tick-long",this.element),this.titleElm=$(".time-title-content",this.element)},a.prototype.attachElement=function(a,b){var c,d,e,f,g=this;return a=$(a),c=new Date(b),d=this.getHourDeg_(c),e=this.getMinuteDeg_(c),f={},$(a).bind("mouseover",function(){return g.hoverTimer=_.delay(function(){var b;return g.clearTimers(),b=$(".label span:last-child",a),f=b.offset(),f.top+=b.height()/2,f.left+=b.width(),window.clearTimeout(g.hideTimer),g.setRotate_(g.shortTickElm,d),g.setRotate_(g.longTickElm,e),g.titleElm.html(g.createTitleHTML(c)),g.element.css({top:f.top,left:f.left}).fadeIn()},400)}).bind("mouseout",function(){return g.clearTimers(),g.hideTimer=_.delay(function(){return g.element.fadeOut()},3e3)})},a.prototype.createTitleHTML=function(a){var b,c;return b=_.padString(a.getHours(),2)+":"+_.padString(a.getMinutes(),2),c=_.niceDate(a),'<span class="time-title-digits">'+b+'</span><br />\n<span class="time-title-nice">'+c+"</span>"},a.prototype.clearTimers=function(){return window.clearTimeout(this.hoverTimer),window.clearTimeout(this.hideTimer)},a.prototype.setRotate_=function(a,b){return a.css(_.getCssPrefix()+"transform","rotate("+b+"deg)")},a.prototype.getHourDeg_=function(a){return Math.floor(30*a.getHours())},a.prototype.getMinuteDeg_=function(a){return Math.floor(6*a.getMinutes())},a}(),_.addSingletonGetter(Time),currentDocs_=[],userId_="",socket=null,message=null,_.mixin({setToken:function(a,b){return _.setCookies({token:a,expires:b})},getToken:function(){var a;return a=_.getCookies(),a.token},setUserId:function(a){return userId_=a},getUserId:function(){return userId_},parseToken:function(a){var b,c,d;a=a.replace(/^#/,""),c=_.parseParamString(a),d=c.access_token||"",b=c.expires_in;if(d&&b)return b=(new Date(_.now()+b*1e3)).toString(),_.setToken(d,b),socket.emit("got token",{token:d})},getSocket:function(){return socket}}),message===null,words=null,time=null,$(function(){var a;return message=Message.getInstance(),message.render(),words=WordList.getInstance(),words.decorate(".word-list"),time=Time.getInstance(),time.render(),socketInit(),a=_.getToken(),a?socket.emit("got token",{token:a}):window.noAuthForDev||_.showLoginLink(),$("#post-form").on("submit",function(a){var b,c,d;return _.isLocked()?!1:(c=_.getUserId(),b=$('input[name="content"]',this).val(),!_.isEmpty(c)&&!_.isEmpty(b)&&(_.isValidWord(b)?(d=words.getLastWord(),c===d.createdBy?message.show("It's not your turn."):_.isValidLastFirst(d.content,b)?socket.emit("post word",{content:b,createdBy:c}):message.show("I'm not sure it's being Last and First.")):message.show("Please enter a word in HIRAGANA.")),!1)})}),$msgBox_=null,postLocked_=!1,$indicator_=null,_.mixin({isLocked:function(){return postLocked_}}),delayTimerId_=null,_.mixin,_.mixin({showLoginLink:function(){return $("#login-link").show()},hideLoginLink:function(){return $("#login-link").hide()},showPostForm:function(){return $("#post-form").show()},setUserIdToHiddenInput:function(){return $("#user-id-input").val(_.getUserId())},showMessage:function(a){var b;return delayTimerId_&&window.clearTimeout(delayTimerId_),b=$msgBox_||($msgBox_=$("#msg-box").click(function(a){return $(this).fadeOut()})),b.text(a).fadeIn(),delayTimerId_=_.delay(function(){return b.fadeOut()},8888)}}),socketInit=function(){return socket=io.connect(location.protocol+"//"+location.host),socket.on("update",function(a){var b,c,d,e,f;words.empty(),f=[];for(d=0,e=a.length;d<e;d++)b=a[d],c=new Word(b,d===0),c.render(),c.attachTime(time),f.push(words.push(c));return f}),socket.on("need login",function(){return message.show("Expired. Need another login."),_.showLoginLink()}),socket.on("validated nicely!",function(a){var b;return b=a.userId,_.setUserId(b),_.setUserIdToHiddenInput(b),message.show("Authorized fine."),_.hideLoginLink(),_.showPostForm(),socket.emit("pull update")}),socket.on("error message",function(a){return message.show(a.message)}),socket.on("posted successfully",function(a){return message.show('"'+a.content+'" posted!')}),socket.on("got penalty",function(a){return message.show(a.message)}),socket.on("release penalty",function(a){return message.show(a.message)}),socket.on("update like",function(a){var b;b=words.get(a._id);if(b){b.liked=a.liked,b.render();if(b.createdBy===_.getUserId())return message.showImportant('Somebody liked your post, "'+b.content+'"')}})}