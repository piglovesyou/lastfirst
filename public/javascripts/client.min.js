(function(){var b,z,r,p,s,w,a,m,e,d,v,l,y,c,u,k,t,j,i,h,g,o;var q=Array.prototype.slice,n=Object.prototype.hasOwnProperty,x=function(D,B){for(var A in B){if(n.call(B,A)){D[A]=B[A]}}function C(){this.constructor=D}C.prototype=B.prototype;D.prototype=new C;D.__super__=B.prototype;return D},f=function(A,B){return function(){return A.apply(B,arguments)}};c=function(D){var C,B,A;C=1;B=D.length;if(B>=2&&/^[ゃゅょ|ー]$/.test(D[1])){if(B>=3&&/^[ー]$/.test(D[2])){C=3}else{C=2}}A=[];_(C).times(function(E){return A.push(D.slice(0,E+1))});return A};u=function(C){var B,D,A;B=1;A=C.length;D=A-1;if(A>=2&&/^[ゃゅょ|ー]$/.test(C[D])){if(A>=3&&/^[ゃゅょ]$/.test(C[D-1])){B=3}else{B=2}}C=_.last(C,B);if(_.isArray(C)){return C=C.join("")}};_.mixin({isValidWord:function(A){if(_.isString(A)&&/^[あ-ん|ー]+$/.test(A)&&/^[^を]+$/.test(A)&&!/っ$/.test(A)){return _.all(A.split(""),function(C,B,D){if(B===0){return/^[^ゃゅょ|^っ|^ー]$/.test(C)}else{if(/^[ゃゅょ]$/.test(C)){return/^[きしちにひみりぎじぢび]$/.test(D[B-1])}if(C==="っ"){return/^[^っ]$/.test(D[B-1])}return true}})}else{return false}},isEndsN:function(A){return/ん$/.test(A)},isValidLastFirst:function(A,B){return _.include(c(B),u(A))}});_.mixin({addSingletonGetter:function(A){return A.getInstance=function(){return A.instance_||(A.instance_=new A())}},parseParamString:function(G,C){var H,F,A,E,B,D;if(C==null){C="&"}A={};D=G.split(C);for(E=0,B=D.length;E<B;E++){F=D[E];H=F.split("=");A[H[0]]=H[1]}return A},stringifyParam:function(E,C){var D,F,H,A,G,B;if(C==null){C="&"}A="";F=_.keys(E);H=F.length-1;for(G=0,B=F.length;G<B;G++){D=F[G];A+=D+"="+E[D];if(G!==H){A+=C}}return A},now:function(){return Date.now()||+new Date()},getCookies:function(){return _.parseParamString(document.cookie,"; ")},setCookies:function(C){var B,A;A=[];for(B in C){A.push(document.cookie=B+"="+C[B])}return A},padString:function(E,B,A){var D,C;if(A==null){A="0"}if(!_.isString(E)){E=E.toString()}D=B-E.length;C="";if(D>=1){_(D).times(function(){return C+=A});E=C+E}return E}});s={WEBKIT:0,GECKO:1,MSIE:2,OPERA:3,OTHER:4};_.mixin({getBrowserVendor:function(){var A;A=navigator.userAgent.toLowerCase();if(A.indexOf("webkit")>=0){return s.WEBKIT}else{if(A.indexOf("gecko")>=0){return s.GECKO}else{if(A.indexOf("msie")>=0){return s.MSIE}else{if(A.indexOf("opera")>=0){return s.OPERA}else{return s.OTHER}}}}}});w=null;_.mixin({getCssPrefix:function(){if(!_.isNull(w)){return w}else{switch(_.getBrowserVendor()){case s.WEBKIT:return w="-webkit-";case s.GECKO:return w="-moz-";case s.MSIE:return w="-ms-";case s.OPERA:return w="-o-";case s.OTHER:return w=""}}},niceDate:(function(G,D){var H,F,E,I,C,A,K,B,L,J,M;C=1000;E=60*C;F=60*E;H=24*F;A=7*H;I=31*H;K=365*H;J={en:{AGO:" ago",AFTER:" after",SECOND:" second",MINUTE:" minute",HOUR:" hour",DAY:" day",WEEK:" week",MONTH:" month",YEAR:" year",PLURAL:"s"},ja:{AGO:"前",AFTER:"後",SECOND:"秒",MINUTE:"分",HOUR:"時間",DAY:"日",WEEK:"週",MONTH:"月",YEAR:"年"}};B={en:{HOUR_MINUTE:"%_:%_",MONTH_DATE:"%_.%_",YEAR_MONTH_DATE:"%_.%_.%_"},ja:{HOUR_MINUTE:"%_:%_",MONTH_DATE:["%_",J.ja.MONTH,"%_",J.ja.DAY].join(""),YEAR_MONTH_DATE:["%_",J.ja.YEAR,"%_",J.ja.MONTH,"%_",J.ja.DAY].join("")}};M=function(N,P,O){N=Math.floor(N);if(O.PLURAL&&N>1){return N+P+O.PLURAL}else{return N+P}};L=function(){var R,Q,O,P,N;R=arguments[0],O=2<=arguments.length?q.call(arguments,1):[];for(P=0,N=O.length;P<N;P++){Q=O[P];R=R.replace("%_",Q)}return R};return function(P,Q){var S,R,N,O;if(_.isString(P)||_.isNumber(P)){P=new Date(P)}if(_.isDate(P)){O=new Date().getTime();Q=_.isString(Q)&&J[Q]?Q:"ja";D=J[Q];N=B[Q];R=O-P.getTime();S=R>0?D.AGO:D.AFTER;R=Math.abs(R);if(R<E){return""+(M(R/C,D.SECOND,D))+S}else{if(R<F){return""+(M(R/E,D.MINUTE,D))+S}else{if(R<H){return""+(M(R/F,D.HOUR,D))+S}else{if(R<H*3){return""+(M(R/H,D.DAY,D))+S}else{if(R<K){return""+(L(N.MONTH_DATE,P.getMonth()+1,P.getDate()))}else{return""+(L(N.YEAR_MONTH_DATE,P.getFullYear(),P.getMonth()+1,P.getDate()))}}}}}}}})()});y=window;p=(function(){function A(){}A.prototype.element=null;A.prototype.getElement=function(){return this.element};A.prototype.isInDocument=false;A.prototype.canRender=function(){return true};A.prototype.render=function(){return this.isInDocument=true};A.prototype.decorate=function(B){this.isInDocument=true;return this.element=$(B)};A.prototype.dispose=function(){var C,B;if(this.isInDocument){this.element.unbind();this.element.remove();B=[];for(C in this){B.push(_.isObject(this[C])?this[C]=null:void 0)}return B}};return A})();d=(function(){x(A,p);function A(){A.__super__.constructor.apply(this,arguments)}A.prototype.wordInstances_=[];A.prototype.empty=function(){var E,D,B,C;C=this.wordInstances_;for(D=0,B=C.length;D<B;D++){E=C[D];E.dispose()}this.wordInstances_=[];return this.element.empty()};A.prototype.renderWords=function(){var F,E,C,D,B;this.element.empty();D=this.wordInstances_;B=[];for(E=0,C=D.length;E<C;E++){F=D[E];B.push(F.render())}return B};A.prototype.push=function(B){this.wordInstances_.push(B);return this.element.append(B.getElement())};A.prototype.shift=function(B){return this.wordInstances_.shift(B)};A.prototype.pop=function(){var B;B=this.wordInstances_.pop();return B.dispose()};A.prototype.get=function(B){return _.find(this.wordInstances_,function(C){return C.id===B})};A.prototype.getLastWord=function(){return this.wordInstances_[0]};return A})();_.addSingletonGetter(d);e=(function(){x(A,p);function A(C,B){this.isLastPost=B;this.sendLike=f(this.sendLike,this);this.id=C._id;this.content=C.content;this.createdBy=C.createdBy;this.createdAt=C.createdAt;this.liked=C.liked;if(this.canRender()){this.element=$('<div class="word"></div>')}}A.prototype.canRender=function(){return !!(this.id&&this.content&&this.createdBy&&this.createdAt&&this.liked)};A.prototype.render=function(){var J,G,D,I,C,L,H,B,E,K,F;if(this.canRender()){A.__super__.render.call(this);this.element.empty();L="";H=_.getUserId();L=this.content;if(_.isEndsN(this.content)){L+="*"}J=$("<span class='content' title='"+this.createdAt+"'>"+L+"</span>");L="";F=this.liked;for(E=0,K=F.length;E<K;E++){G=F[E];L+="6"}C=$("<span class='liked i'>"+L+"</span>");this.element.append(J).append(C);if(H&&H!==this.createdBy&&!_.include(this.liked,H)){I=$("<span class='like i' title='like it'>6</span>").bind("click",this.sendLike);this.element.append(I)}if(this.isLastPost){D=$('<span class="last-post">&lt-last post</span>');this.element.append(D)}if(H===this.createdBy){B=$('<span class="your-post">&lt-your post!</span>');return this.element.append(B)}}};A.prototype.attachTime=function(B){this.time=B;return this.time.attachElement(this.element,this.createdAt)};A.prototype.sendLike=function(C){var B;B=_.getSocket();if(B){return B.emit("like",{wordId:this.id,userId:_.getUserId()})}};return A})();_.addSingletonGetter(e);a=(function(){x(A,p);function A(){A.__super__.constructor.apply(this,arguments)}A.prototype.messageElm_=null;A.prototype.importantMessageElm_=null;A.prototype.render=function(){var D,C,B;A.__super__.render.call(this);D=null;C=null;this.element=$('<div id="msg-box" title="close this message"></div>');B=function(F){var E;E=F.data.$that;$(window.document).unbind("mousemove",B);return D=_.delay(function(){return E.trigger("hide")},7*1000)};this.importantMessageElm_=$('<div class="msg important"></div>').hide().bind("hide",function(E){window.clearTimeout(D);$(window.document).unbind("mousemove",B);return $(this).fadeOut()}).bind("show",function(F,G){var E;window.clearTimeout(D);E=$(this).text(G);E.fadeIn();return $(window.document).bind("mousemove",{$that:E},B)}).bind("click",function(E){return $(this).trigger("hide")});this.messageElm_=$('<div class="msg"></div>').hide().bind("hide",function(E){window.clearTimeout(C);return $(this).fadeOut()}).bind("show",function(F,G){var E;window.clearTimeout(C);E=$(this).text(G);E.fadeIn();return C=_.delay(function(){return E.trigger("hide")},7*1000)}).bind("click",function(E){return $(this).trigger("hide")});return this.element.append(this.importantMessageElm_).append(this.messageElm_).appendTo("body")};A.prototype.show=function(B){return this.messageElm_.trigger("show",B)};A.prototype.showImportant=function(B){return this.importantMessageElm_.trigger("show",B)};A.prototype.dispose=function(){this.importantMessageElm_.unbind();this.messageElm_.unbind();return A.__super__.dispose.call(this)};return A})();_.addSingletonGetter(a);m=(function(){x(A,p);function A(){A.__super__.constructor.apply(this,arguments)}A.prototype.shortTickElm=null;A.prototype.longTickElm=null;A.prototype.titleElm=null;A.prototype.height=0;A.prototype.hideTimer=null;A.prototype.render=function(){A.__super__.render.call(this);this.element=$('<div class="time" style="display:none"><div class="time-arrow"></div><div class="time-bg"><div class="time-round clearfix"><div class="time-label"><div class="time-label-twelve">12</div><div class="time-label-three">3</div><div class="time-label-six">6</div><div class="time-label-nine">9</div></div><div class="time-tick"><div class="time-tick-short"></div><div class="time-tick-long"></div></div><div class="time-tick-center"></div></div><div class="time-title"><div class="time-title-content"></div></div></div></div>');$("body").append(this.element);this.element.css({"margin-top":this.element.height()/-2});this.shortTickElm=$(".time-tick-short",this.element);this.longTickElm=$(".time-tick-long",this.element);return this.titleElm=$(".time-title-content",this.element)};A.prototype.attachElement=function(G,E){var B,D,C,F;G=$(G);B=new Date(E);D=this.getHourDeg_(B);C=this.getMinuteDeg_(B);F=null;_.defer(function(){F=G.offset();F.left+=G.width()/2;return F.top+=G.height()/2});return $(G).bind("mouseover",f(function(){window.clearTimeout(this.hideTimer);this.setRotate_(this.shortTickElm,D);this.setRotate_(this.longTickElm,C);this.titleElm.html(this.createTitleHTML(B));return this.element.css({top:F.top,left:F.left}).fadeIn()},this)).bind("mouseout",f(function(){return this.hideTimer=_.delay(f(function(){return this.element.fadeOut()},this),3000)},this))};A.prototype.createTitleHTML=function(B){var D,C;D=_.padString(B.getHours(),2)+":"+_.padString(B.getMinutes(),2);C=_.niceDate(B);return'<span class="time-title-digits">'+D+'</span><br />\n<span class="time-title-nice">'+C+"</span>"};A.prototype.setRotate_=function(C,B){return C.css(_.getCssPrefix()+"transform","rotate("+B+"deg)")};A.prototype.getHourDeg_=function(B){return Math.floor(360/12*B.getHours())};A.prototype.getMinuteDeg_=function(B){return Math.floor(360/60*B.getMinutes())};return A})();_.addSingletonGetter(m);y.WordList=d;y.Word=e;y.Message=a;y.Time=m;v=[];g="";j=null;o=null;k=null;_.mixin({setToken:function(B,A){return _.setCookies({token:B,expires:A})},getToken:function(){var A;A=_.getCookies();return A.token},setUserId:function(A){return g=A},getUserId:function(){return g},parseToken:function(D){var A,C,B;D=D.replace(/^#/,"");C=_.parseParamString(D);B=C.access_token||"";A=C.expires_in;if(B&&A){A=new Date(_.now()+A*1000).toString();_.setToken(B,A);return j.emit("got token",{token:B})}else{}},getSocket:function(){return j}});k===null;o=null;h=null;$(function(){var A,B;k=a.getInstance();k.render();o=d.getInstance();o.decorate("#word-list");h=m.getInstance();h.render();i();B=_.getToken();if(B){j.emit("got token",{token:B})}else{_.showLoginLink()}_.disableForm(false);A=$("#post");return A.submit(function(E){var D,F,C;if(_.isLocked()){return false}_.disableForm(true);F=_.getUserId();D=$('input[name="content"]',A).val();if(_.isEmpty(F)||_.isEmpty(D)){_.disableForm(false)}else{if(_.isValidWord(D)){C=o.getLastWord();if(F===C.createdBy){k.show("It's not your turn.");_.disableForm(false)}else{if(_.isValidLastFirst(C.content,D)){j.emit("post word",{content:D,createdBy:F})}else{k.show("I'm not sure it's being Last and First.");_.disableForm(false)}}}else{k.show("Please enter a word in HIRAGANA.");_.disableForm(false)}}return false})});r=null;t=false;b=null;z=null;_.mixin({isLocked:function(){return t},disableForm:function(C,A){var B;t=C;B=z||(z=$("#post-form input"));if(C){B.attr({disabled:"disabled"})}else{B.removeAttr("disabled")}if(!A){return _.showIndicator(C)}}});l=null;_.mixin({hideWaitSecMessage:function(){return $("#wait-sec-message").hide()},showIndicator:function(A){var B;B=b||(b=$("#post-form #indicator"));if(B){if(A){return B.addClass("loading")}else{return B.removeClass("loading")}}}});_.mixin({showLoginLink:function(){_.hideWaitSecMessage();return $("#login-link").show()},hideLoginLink:function(){return $("#login-link").hide()},showPostForm:function(){_.hideWaitSecMessage();return $("#post-form").show()},setUserIdToHiddenInput:function(){return $("#user-id-input").val(_.getUserId())},showMessage:function(B){var A;if(l){window.clearTimeout(l)}A=r||(r=$("#msg-box").click(function(C){return $(this).fadeOut()}));A.text(B).fadeIn();return l=_.delay(function(){return A.fadeOut()},8888)}});i=function(){j=io.connect(location.protocol+"//"+location.host);j.on("update",function(F){var E,D,C,B,A;o.empty();A=[];for(C=0,B=F.length;C<B;C++){E=F[C];D=new e(E,C===0);D.render();D.attachTime(h);A.push(o.push(D))}return A});j.on("need login",function(){k.show("Expired. Need another login.");return _.showLoginLink()});j.on("validated nicely!",function(A){var B;B=A.userId;_.setUserId(B);_.setUserIdToHiddenInput(B);k.show("Authorized fine.");_.hideLoginLink();return _.showPostForm()});j.on("error message",function(A){k.show(A.message);return _.disableForm(false)});j.on("posted successfully",function(A){k.show('"'+A.content+'" posted!');return _.disableForm(false)});j.on("got penalty",function(A){k.show(A.message);_.disableForm(true);return _.showIndicator(false)});j.on("release penalty",function(A){k.show(A.message);return _.disableForm(false)});return j.on("update like",function(A){var B;B=o.get(A._id);if(B){B.liked=A.liked;B.render();if(B.createdBy===_.getUserId()){return k.showImportant('Somebody liked your post, "'+B.content+'"')}}})}}).call(this);